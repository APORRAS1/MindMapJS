/*! MindMapJS v0.1.1 2013-07-19 Por José Luis Molina Soria */
var MM={};if("undefined"!=typeof module&&(module.exports=MM),"undefined"!=typeof module){var MM=require("./MindMapJS.js");MM.PubSub=require("./pubsub.js")}MM.Arbol=MM.PubSub.extend({init:function(a,b){this.elemento=a,this.hijos=b||[]}}),MM.Arbol.prototype.preOrden=function(){this.on("preOrden",this);var a=[this.elemento];return this.hijos.forEach(function(b){a=a.concat(b.preOrden())}),this.on("postPreOrden",this),a},MM.Arbol.prototype.generalPreOrden=function(a,b){this.on("preOrden",this);var c=a(this.elemento);return this.hijos.forEach(function(d){b(c,d.generalPreOrden(a,b))}),this.on("postPreOrden",this),c},MM.Arbol.prototype.inOrden=function(){if(0===this.ordenNodo())return[this.elemento];var a=[];return this.hijos.forEach(function(b,c){a=a.concat(b.inOrden()),0===c&&(a=a.concat(this.elemento),this.on("inOrden",this))},this),this.on("postInOrden",this),a},MM.Arbol.prototype.postOrden=function(){var a=[];return this.hijos.forEach(function(b){a=a.concat(b.postOrden())}),this.on("postOrden",this),a.concat(this.elemento)},MM.Arbol.prototype.ordenNodo=function(){return this.hijos.length},MM.Arbol.prototype.orden=function(){var a=this.hijos.map(function(a){return a.orden()});return a.push(this.ordenNodo()),Math.max.apply(null,a)},MM.Arbol.prototype.peso=function(){var a=1;return this.hijos.forEach(function(b){a+=b.peso()}),a},MM.Arbol.prototype.altura=function(){var a=0;return this.hijos.forEach(function(b){a=Math.max(a,b.altura())}),a+1},MM.Arbol.prototype.esHoja=function(){return 0===this.hijos.length},MM.Arbol.prototype.elementEqual=function(a){return a===this.elemento},MM.Arbol.prototype.buscar=function(a){if(this.elementEqual(a))return this;var b=null;return this.hijos.forEach(function(c){var d=c.buscar(a);null!==d&&(b=d),d=null}),b},MM.Arbol.prototype.profundidad=function(a){if(this.elementEqual(a))return 0;var b=-1;return this.hijos.forEach(function(c){var d=c.profundidad(a);-1!==d&&(b=d+1)}),b},MM.Arbol.prototype.padreDe=function(a){if(this.elementEqual(a))return null;var b=!1;return this.hijos.forEach(function(c){c.elementEqual(a)&&(b=this)},this),b?this:(b=null,this.hijos.forEach(function(c){null===b&&(b=c.padreDe(a))}),b)},MM.Arbol.prototype.borrar=function(a){var b=this.padreDe(a),c=null;if(null!==b)for(var d=0;d<=b.hijos.length;d++)if(b.hijos[d].elementEqual(a)){c=b.hijos[d],b.hijos.splice(d,1);break}return b=null,c};var ArbolN=function(a){var b=Array.prototype.slice.call(arguments,1);return new MM.Arbol(a,b)};if("undefined"!=typeof module&&(module.exports.ArbolN=ArbolN,module.exports.Arbol=MM.Arbol),MM.Arista=MM.Class.extend({init:function(a,b,c,d){this.capa=a,this.elementoOrigen=b,this.elementoDestino=c,this.context=a.getCanvas().getContext(),this.tamano=d,this.render()},calcularPuntos:function(){var a=this.elementoOrigen.nodo,b=this.elementoDestino.nodo;this.x1=(a.getX()+MM.render.offset.x+a.getWidth()/2)*MM.render.getEscala(),this.y1=(a.getY()+MM.render.offset.y+a.getHeight()/2)*MM.render.getEscala(),this.x2=(b.getX()+MM.render.offset.x+b.getWidth()/2)*MM.render.getEscala(),this.y2=(b.getY()+MM.render.offset.y+b.getHeight()/2)*MM.render.getEscala(),this.c1x=this.x1+(this.x2-this.x1)/2,this.c1y=this.y1,this.c2x=this.x1+(this.x2-this.x1)/2,this.c2y=this.y2,a=b=null},render:function(){var a=this.context;this.calcularPuntos(),a.beginPath(),a.moveTo(this.x1,this.y1),a.bezierCurveTo(this.c1x,this.c1y,this.c2x,this.c2y,this.x2,this.y2),a.strokeStyle="#555",a.lineWidth=this.tamano*MM.render.getEscala(),a.stroke(),a=null}}),MM.Rama=MM.Arista.extend({init:function(a,b,c,d){this._super(a,b,c,d)},calcularPuntos:function(){var a=this.elementoOrigen.nodo,b=this.elementoDestino.nodo;this.x1=(a.getX()+MM.render.offset.x+a.getWidth())*MM.render.getEscala(),this.y1=(a.getY()+MM.render.offset.y+a.getHeight())*MM.render.getEscala(),this.x2=b.getX()+MM.render.offset.x*MM.render.getEscala(),this.y2=(b.getY()+MM.render.offset.y+b.getHeight())*MM.render.getEscala(),this.x3=(b.getX()+MM.render.offset.x+b.getWidth())*MM.render.getEscala(),this.y3=(b.getY()+MM.render.offset.x+b.getHeight())*MM.render.getEscala(),this.c1x=this.x1+(this.x2-this.x1)/2,this.c1y=this.y1,this.c2x=this.x1+(this.x2-this.x1)/2,this.c2y=this.y2,a=b=null},render:function(){var a=this.context;this.calcularPuntos(),a.beginPath(),a.moveTo(this.x1,this.y1),a.bezierCurveTo(this.c1x,this.c1y,this.c2x,this.c2y,this.x2,this.y2),a.strokeStyle=this.elementoOrigen.nodo.color,a.lineWidth=this.tamano*MM.render.getEscala(),a.lineTo(this.x3,this.y3),a.stroke(),a.beginPath(),a.moveTo(this.x2,this.y2),a.strokeStyle=this.elementoDestino.nodo.color,a.lineWidth=this.tamano*MM.render.getEscala(),a.lineTo(this.x3,this.y3),a.stroke(),a=null}}),MM.definirAtajos=function(){MM.teclado.atajos.add("Ctrl++",MM.render.zoomIn,MM),MM.teclado.atajos.add("Ctrl+-",MM.render.zoomOut,MM),MM.teclado.atajos.add("Ctrl+0",MM.render.zoomReset,MM),MM.teclado.atajos.add("ins",MM.add,MM),MM.teclado.atajos.add("Shift+Tab",MM.add,MM),MM.teclado.atajos.add("del",MM.borrar,MM),MM.teclado.atajos.add("Shift+Enter",function(){MM.render.modoEdicion()?MM.render.insertarSaltoDeLinea():MM.padre().add()},MM),MM.teclado.atajos.add("enter",MM.render.editar,MM),MM.teclado.atajos.add("esc",function(){MM.render.modoEdicion()&&MM.render.editar()},MM),MM.teclado.atajos.add("shift++",function(){alert("desplegar")},MM),MM.teclado.atajos.add("shift+-",function(){alert("plegar")},MM),MM.teclado.atajos.add("home",MM.root,MM),MM.teclado.atajos.add("left",MM.padre,MM),MM.teclado.atajos.add("right",MM.next,MM),MM.teclado.atajos.add("up",MM.prevHermano,MM),MM.teclado.atajos.add("down",MM.nextHermano,MM),MM.teclado.atajos.add("tab",function(){MM.render.modoEdicion()?MM.render.editar():MM.foco.esHoja()?MM.add():MM.next()},MM)},MM.Borde=MM.Class.extend({init:function(a,b,c){this.capa=a,this.width=b,this.height=c,this.render()},render:function(){this.capa.add(new Kinetic.Line({points:[0,0,this.width,0],stroke:"grey",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[4,3]})),this.capa.add(new Kinetic.Line({points:[0,0,0,this.height],stroke:"grey",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[4,3]})),this.capa.add(new Kinetic.Line({points:[0,this.height,this.width,this.height],stroke:"grey",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[4,3]})),this.capa.add(new Kinetic.Line({points:[this.width,0,this.width,this.height],stroke:"grey",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[4,3]}))}}),Function.prototype.chain=function(){var a=this;return function(){var b=a.apply(this,arguments);return void 0===b?this:b}},MM.color={},MM.color.randomHslColor=function(){var a=function(a,b){return parseInt(Math.random()*(a-b+1),10)+b};return{h:a(1,360),s:a(30,100),l:a(20,50)}},MM.color.addBrillo=function(a,b){return b=b||0,{h:a.h,s:a.s,l:a.l+b}},MM.color.hslToCSS=function(a,b){return b=b||0,"hsl("+Math.floor(a.h)+","+Math.floor(a.s)+"%,"+Math.floor(a.l+b)+"%)"},MM.color.rgbToCSS=function(a){return"rgb("+Math.floor(a.r)+", "+Math.floor(a.g)+", "+Math.floor(a.b)+")"},MM.color.rgbToHexCSS=function(a){return"#"+MM.color.intToHex(a.r)+MM.color.intToHex(a.g)+MM.color.intToHex(a.b)},MM.color.intToHex=function(a,b){b=b||2;for(var c=Math.floor(a).toString(16);c.length<b;)c="0"+c;return c},MM.color.hue=function(a,b,c){var d=0;if(0!==c)switch(b){case a.r:d=60*((a.g-a.b)/c),0>d&&(d+=360);break;case a.g:d=60*((a.b-a.r)/c)+120;break;case a.b:d=60*((a.r-a.g)/c)+240}return d},MM.color.rgbToHsl=function(a){var b=Math.max(a.r,a.g,a.b),c=b-Math.min(a.r,a.g,a.b),d=b/255-c/510;return{h:MM.color.hue(a,b,c),s:0===c?0:c/2.55/(.5>d?2*d:2-2*d),l:100*d}},MM.color.hslToRgb=function(a){var b={r:2.55*a.l,g:2.55*a.l,b:2.55*a.l};if(0!==a.s){var c=a.l<50?a.l*(1+a.s/100):a.l+a.s-a.l*a.s/100,d=2*a.l-c;b={r:(a.h+120)/60%6,g:a.h/60,b:(a.h+240)/60%6};for(var e in b)b.hasOwnProperty(e)&&(b[e]=b[e]<1?d+(c-d)*b[e]:b[e]<3?c:b[e]<4?d+(c-d)*(4-b[e]):d,b[e]*=2.55)}return b},MM.comandos={},MM.comandos.Insertar=MM.UndoManager.ComandoHacerDeshacer.extend({init:function(a,b,c){this._super("Añadir nuevo hijo "+c,function(){var d=MM.arbol.buscar(a),e=new MM.Arbol({id:b,texto:c,nodo:null});MM.ponerFoco(d),d.hijos.push(e),MM.eventos.on("add",d,e),d=e=null},function(){var c=MM.arbol.buscar(a),d=MM.arbol.buscar(b);MM.ponerFoco(c),MM.arbol.borrar(b),MM.eventos.on("borrar",c,d),c=d=null})}}),MM.comandos.Borrar=MM.UndoManager.ComandoHacerDeshacer.extend({init:function(a,b){var c=function(a){return new MM.Arbol({id:a.id,texto:a.texto,nodo:null})},d=function(a,b){a.hijos.push(b)},e=function(a){MM.render.repartoEspacio(a)},f=function(a){var b=a.elemento;a.hijos.forEach(function(c){if(null===MM.render.buscarArista(a,c)){var d=new MM.render.Arista(MM.render.capaAristas,b,c.elemento,"3");MM.render.aristas.push(d)}d=null}),b=null},g=a.elemento.id,h=b.generalPreOrden(c,d);this._super("Borrar "+h.elemento.texto,function(){var a=MM.arbol.buscar(g);MM.ponerFoco(a);var b=MM.arbol.borrar(h.elemento.id);MM.eventos.on("borrar",a,b),a=b=null},function(){var a=MM.arbol.buscar(g);MM.ponerFoco(a);var b=h.generalPreOrden(c,d);if(a.hijos.push(b),MM.render){var i=a.suscribir("preOrden",e),j=a.suscribir("postPreOrden",f);a.preOrden(),a.desSuscribir(i),a.desSuscribir(j),i=j=null,MM.render.renderAristas(),MM.render.capaNodos.draw()}a=b=null})}}),MM.comandos.Nuevo=MM.UndoManager.ComandoHacerDeshacer.extend({init:function(){this._super("nuevo",function(){},function(){})}}),MM.comandos.Editar=MM.UndoManager.ComandoHacerDeshacer.extend({init:function(a,b,c){this._super("Editar "+b,function(){var b=MM.arbol.buscar(a);b.elemento.texto=c,b.elemento.nodo&&b.elemento.nodo.setText(c),b=null},function(){var c=MM.arbol.buscar(a);c.elemento.texto=b,c.elemento.nodo.setText(b),c=null})}}),MM.comandos.Zoom=MM.UndoManager.ComandoHacerDeshacer.extend({init:function(a,b){this._super("Zoom",function(){MM.render.setEscala(b)},function(){MM.render.setEscala(a)})}}),MM.demo={},MM.demo.timerDeslizador=null,MM.demo.deslizar=function(a,b){var c="-500px",d="25px",e=document.getElementById(a);b=b||[],e.style.top===d?e.style.top=c:(e.style.top===c||""===e.style.top)&&(b.forEach(function(a){document.getElementById(a).style.top=c}),e.style.top=d,MM.demo.timerDeslizador&&window.clearTimeout(MM.demo.timerDeslizador),MM.demo.timerDeslizador=window.setTimeout(function(){e.style.top===d&&(e.style.top=c)},5e3))},MM.demo.ayuda=function(){MM.demo.deslizar("ayuda",["datosDelProyecto"])},MM.demo.datosDelProyecto=function(){MM.demo.deslizar("datosDelProyecto",["ayuda"])},MM.demo.hacer=function(){MM.undoManager.hacer()},MM.demo.deshacer=function(){MM.undoManager.deshacer()},MM.demo.cambioUndoManager=function(){var a=document.getElementById("btnHacer"),b=document.getElementById("btnDeshacer"),c=document.getElementById("iconHacer"),d=document.getElementById("iconDeshacer");null===MM.undoManager.hacerNombre()?(a.setAttribute("disabled","disabled"),a.setAttribute("title",""),c.setAttribute("style","color: #ddd;")):(a.hasAttribute("disabled")&&(a.removeAttribute("disabled"),c.removeAttribute("style")),a.setAttribute("title","Hacer "+MM.undoManager.hacerNombre())),null===MM.undoManager.deshacerNombre()?(b.setAttribute("disabled","disabled"),b.setAttribute("title",""),d.setAttribute("style","color: #ddd;")):(b.hasAttribute("disabled")&&(b.removeAttribute("disabled"),d.removeAttribute("style")),b.setAttribute("title","Deshacer "+MM.undoManager.deshacerNombre())),a=b=null},window.onload=function(){MM.add("hijo1").add("hijo2").add("hijo3").add("hijo4").next().add("hijo11").add("hijo12").add("hijo13"),MM.renderizar("contenedorEditor"),MM.undoManager.eventos.suscribir("cambio",MM.demo.cambioUndoManager),MM.demo.cambioUndoManager()},MM.DOM={},MM.DOM.create=function(a,b){var c=window.document.createElement(a);for(var d in b)"innerHTML"===d?c[d]=b[d]:c.setAttribute(d,b[d]);return c.remove=function(){this.parentNode.removeChild(this)},c},"undefined"!=typeof module){var MM=require("./MindMapJS.js");MM.Class=require("./klass.js"),MM.PubSub=require("./pubsub.js")}if(MM.exportar={},MM.exportar.freemind=function(){var a=function(){for(var a=MM.DOM.create("div"),d=MM.DOM.create("map",{version:"0.9.0"}),e=MM.arbol.generalPreOrden(b,c),f=0;f<e.length;f++)d.appendChild(e[f]);return a.appendChild(d),a.innerHTML},b=function(a){var b=(new Date).getTime(),c=MM.DOM.create("node",{BACKGROUND_COLOR:MM.color.rgbToHexCSS(MM.color.hslToRgb(MM.color.addBrillo(a.nodo.hslColor,40))),COLOR:MM.color.rgbToHexCSS(MM.color.hslToRgb(a.nodo.hslColor)),CREATE:b,ID:"ID_"+Math.floor(1e11*Math.random()+1),MODIFIED:b,STYLE:"bubble",TEXT:a.texto}),d=MM.DOM.create("edge",{STYLE:"bezier",COLOR:MM.color.rgbToHexCSS(MM.color.hslToRgb(a.nodo.hslColor))});return c.appendChild(d),b=null,[c]},c=function(a,b){for(var c=0;c<b.length;c++)a[0].appendChild(b[c]);c=null},d=function(){window.URL=window.URL||window.webkitURL,window.URL||alert("Operación no soportada por su navegador");var b=new Blob([a()],{type:"application/xml"}),c=window.document.createElement("a");c.download=MM.arbol.elemento.texto+".mm",c.href=window.URL.createObjectURL(b),c.click()};return{grabar:d}}(),MM.Grid=MM.Class.extend({init:function(a,b,c){this.capa=a,this.width=b,this.height=c,this.render()},render:function(){for(var a=-2*this.width,b=2*this.width,c=-2*this.height,d=2*this.height,e=a;e<=2*this.width;e+=100)this.capa.add(new Kinetic.Line({points:[e,c,e,d],stroke:"grey",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[.8,5]}));for(var f=-2*this.height;f<=2*this.height;f+=100)this.capa.add(new Kinetic.Line({points:[a,f,b,f],stroke:"grey",strokeWidth:1,lineCap:"round",lineJoin:"round",dashArray:[.8,5]}));e=f=a=b=c=d=null}}),"undefined"!=typeof module){var MM=require("./MindMapJS.js");MM.Class=require("./pubsub.js")}if(MM.importar=function(){var a=new MM.PubSub,b=function(a,b){if(a){var c=new FileReader;c.onloadstart=d,c.onprogress=g,c.onload=h,c.onabort=f,c.onerror=i,c.onloadend=e,c.readAsText(a,b||"UTF-8")}},c=function(a){if(a){var b=new FileReader;b.onloadstart=d,b.onprogress=g,b.onload=h,b.onabort=f,b.onerror=i,b.onloadend=e,b.readAsDataURL(a)}},d=function(b){a.on("inicio",b)},e=function(b){a.on("fin",b)},f=function(b){a.on("abortado",b)},g=function(b){if(b.lengthComputable){var c=100*(b.loaded/b.total);100>c&&a.on("progreso",c,b)}},h=function(b){a.on("cargado",b.target.result,b)},i=function(b){"NotFoundError"!==b.target.error.name&&("SecurityError"===b.target.error.name&&a.on("error/seguridad",b),"NotReadableError"===b.target.error.name&&a.on("error/lectura",b),"EncodingError"===b.target.error.name&&a.on("error/encoding",b))};return{evento:a,texto:b,dataURL:c}}(),MM.importar.XML=function(){var a=MM.Class.extend({cargar:function(a,c){this.idSusCargado=MM.importar.evento.suscribir("cargado",b,this),this.idSusErrorSeg=MM.importar.evento.suscribir("error/seguridad",d,this),this.idSusErrorLec=MM.importar.evento.suscribir("error/lectura",d,this),this.idSusErrorEnc=MM.importar.evento.suscribir("error/encoding",d,this),MM.importar.texto(a,c)}}),b=function(a){var b=e(a);MM.importar.evento.on("xml/parseado",b);var d=c(b.documentElement);MM.importar.evento.on("xml/procesado",d),MM.importar.evento.desSuscribir(this.idSusCargado),MM.importar.evento.desSuscribir(this.idSusErrorSeg),MM.importar.evento.desSuscribir(this.idSusErrorLec),MM.importar.evento.desSuscribir(this.idSusErrorEnc)},c=function(a){var b,d={nombre:a.nodeName,hijos:[]};if(a.attributes)for(b=0;b<a.attributes.length;b++)d[a.attributes[b].name]=a.attributes[b].value;if(a.childNodes)for(b=0;b<a.childNodes.length;b++)3===a.childNodes[b].nodeType?d.texto=a.childNodes[b].nodeValue:1===a.childNodes[b].nodeType&&d.hijos.push(c(a.childNodes[b]));return b=null,d},d=function(a){console.log(a)},e=function(a){var b,c;return window.DOMParser?(c=new DOMParser,b=c.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a)),c=null,b};return a}(),MM.importar.FreeMind=function(){var a=MM.importar.XML.extend({cargar:function(a,c){this.idSus=MM.importar.evento.suscribir("xml/procesado",b,this),this._super(a,c)}}),b=function(a){if("map"!==a.nombre||1!==a.hijos.length)return MM.importar.evento.on("freeMind/error","No se trata de un fichero FreeMind válido"),void 0;var b=a.hijos[0];MM.nuevo(b.TEXT),MM.importar.evento.on("freeMind/raiz",b.TEXT),d(b),MM.importar.evento.on("freeMind/procesado"),MM.importar.evento.desSuscribir(this.idSus),b=null},c=function(a){MM.add(a.TEXT).next().lastHermano(),d(a),MM.padre()},d=function(a){for(var b=0;b<a.hijos.length;b++)"node"===a.hijos[b].nombre&&c(a.hijos[b]);b=null};return a}(),"undefined"!=typeof module&&(module.exports=MM.importar),"undefined"!=typeof module)var MM=require("./MindMapJS.js");if(MM.Class=function(){this.init=function(){}},MM.Class.extend=function(a){function b(){}function c(){this.init&&this.init.apply(this,arguments)}var d=this.prototype||MM.Class.prototype;b.prototype=d;var e=new b,f=function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}};for(var g in a)e[g]="function"==typeof a[g]&&"function"==typeof d[g]?f(g,a[g]):a[g];return c.prototype=e,c.prototype.constructor=c,c.extend=this.extend,c},MM.Class.bind=function(a,b){return function(){return b.apply(a,arguments)}},"undefined"!=typeof module&&(module.exports=MM.Class),MM.Mensaje=MM.Class.extend({defecto:{x:5,y:5,text:"",fontSize:14,fontFamily:"helvetica",fill:"#555",width:"auto",align:"center"},init:function(a,b,c){this.escenario=a,this.capa=b;var d=MM.Properties.add(this.defecto,c);this.kText=new Kinetic.Text(d),b.add(this.kText)},setText:function(a){this.kText.setText(a),this.capa.draw()},getText:function(){return this.kText.getText()},setX:function(a){this.kText.setX(a),this.capa.draw()},getX:function(){return this.kText.getAbsolutePosition().x},setY:function(a){this.kText.setY(a),this.capa.draw()},getY:function(){return this.kText.getAbsolutePosition().y},getWidth:function(){return this.kText.getWidth()},getHeight:function(){return this.kText.getHeight()}}),MM=function(a){var b=1;return a.undoManager=new MM.UndoManager(10),a.eventos=new MM.PubSub,MM.Arbol.prototype.elementEqual=function(a){return a===this.elemento.id},a.nuevo=function(a){if(this.arbol){this.ponerFoco(this.arbol);for(var c=0;c<this.arbol.hijos.length;c)this.next(),this.borrar();this.eventos.on("nuevo/pre")}b=1,this.arbol=this.foco=new MM.Arbol({id:b++,texto:a||"Idea Central",nodo:null}),this.ponerFoco(this.arbol),this.eventos.on("nuevo/post")},a.add=function(a){a=a||"Nueva idea";var c=new MM.Arbol({id:b++,texto:a,nodo:null});this.foco.hijos.push(c),this.undoManager.add(new MM.comandos.Insertar(this.foco.elemento.id,c.elemento.id,a)),this.eventos.on("add",this.foco,c),c=null}.chain(),a.borrar=function(){if(this.arbol===this.foco)return this.nuevo(),void 0;var a=this.foco;this.padre(),this.arbol.borrar(a.elemento.id),this.undoManager.add(new MM.comandos.Borrar(this.foco,a)),this.eventos.on("borrar",this.foco,a),a=null}.chain(),a.next=function(){0!==this.foco.ordenNodo()&&(this.eventos.on("next",this.foco,this.foco.hijos[0]),this.ponerFoco(this.foco.hijos[0]))}.chain(),a.padre=function(){if(this.foco){var a=this.arbol.padreDe(this.foco.elemento.id);null!==a&&(this.eventos.on("padre",this.foco,a),this.ponerFoco(a)),a=null}}.chain(),a.nextHermano=function(){var a=this.arbol.padreDe(this.foco.elemento.id);if(null!==a){for(var b=0;b<a.hijos.length;b++)if(a.hijos[b].elementEqual(this.foco.elemento.id)){b===a.hijos.length-1?(this.eventos.on("nextHermano",this.foco,a.hijos[0]),this.ponerFoco(a.hijos[0])):(this.eventos.on("nextHermano",this.foco,a.hijos[b+1]),this.ponerFoco(a.hijos[b+1]));break}a=null}}.chain(),a.prevHermano=function(){var a=this.arbol.padreDe(this.foco.elemento.id);if(null!==a){for(var b=0;b<a.hijos.length;b++)if(a.hijos[b].elementEqual(this.foco.elemento.id))return 0===b?(this.eventos.on("prevHermano",this.foco,a.hijos[a.hijos.length-1]),this.ponerFoco(a.hijos[a.hijos.length-1])):(this.eventos.on("prevHermano",this.foco,a.hijos[b-1]),this.ponerFoco(a.hijos[b-1])),void 0;a=null}}.chain(),a.lastHermano=function(){var a=this.arbol.padreDe(this.foco.elemento.id);null!==a&&(a.hijos.length>=1&&this.ponerFoco(a.hijos[a.hijos.length-1]),a=null)}.chain(),a.root=function(){this.eventos.on("root",this.foco,this.arbol),this.ponerFoco(this.arbol)}.chain(),a.ponerFoco=function(a){this.eventos.on("ponerFoco",this.foco,a),this.foco=a},a.nuevo("Idea Central"),a.render=null,a.renderizar=function(b,c,d){a.render=new MM.Render(b,c,d),a.render.renderizar()},a.cargarFreeMind=function(){var a=new MM.importar.FreeMind;MM.importar.evento.suscribir("freeMind/raiz",function(){MM.render.desuscribrirEventos()}),MM.importar.evento.suscribir("freeMind/procesado",function(){MM.render.renderizar()});var b=MM.DOM.create("input",{type:"file",id:"ficheros"});b.addEventListener("change",function(){0!==b.files.length&&a.cargar(b.files[0])},!1),b.click()},a}(MM),MM.NodoSimple=MM.Mensaje.extend({defecto:{x:0,y:0,text:"",fontSize:12,fontFamily:"helvetica",fill:"#555",width:"auto",padding:5,align:"center"},init:function(a,b,c){this.render=a,this.escenario=a.escenario,this.capa=a.capaNodos,this.arbol=b,this.hslColor=MM.color.randomHslColor(),this.colorFondo=MM.color.hslToCSS(this.hslColor,40),this.color=MM.color.hslToCSS(this.hslColor);var d=MM.Properties.add(this.defecto,c);d.x=0,d.y=0,d.fill=this.color,this.kText=new Kinetic.Text(d),this.group=new Kinetic.Group({x:c.x,y:c.y,width:this.kText.getWidth(),height:this.kText.getHeight(),draggable:!0,dragBoundFunc:function(b){return a.renderAristas(),b}}),this.rect=new Kinetic.Blob({points:[{x:0,y:0},{x:this.kText.getWidth(),y:0},{x:this.kText.getWidth(),y:this.kText.getHeight()},{x:0,y:this.kText.getHeight()}],stroke:this.color,strokeWidth:2,fill:this.colorFondo,shadowColor:"black",shadowBlur:5,shadowOffset:[3,3],shadowOpacity:.5,tension:.3}),this.line=new Kinetic.Line({points:[{x:0,y:this.kText.getHeight()},{x:this.kText.getWidth(),y:this.kText.getHeight()}],stroke:this.color,strokeWidth:3,lineCap:"round",lineJoin:"round"}),this.group.add(this.rect),this.group.add(this.line),this.group.add(this.kText),this.capa.add(this.group),this.rect.hide();var e=MM.Class.bind(MM.render,MM.render.editar),f=MM.Class.bind(this,this.nop),g=MM.Class.bind(this,function(){MM.ponerFoco(this.arbol)});this.group.on("click tab",g),this.group.on("dblclick dbltap",e),this.group.on("mouseout",f),this.group.on("mousemove",f),this.group.on("mousedown",f),this.group.on("mouseup",f),this.group.on("mouseenter",f),this.group.on("mouseLeave",f),this.group.on("dragstart",f),this.group.on("dragend",f)},ponerFoco:function(){this.kText.setFontStyle("bold"),this.kText.setText("<"+this.arbol.elemento.texto+">"),this.capa.draw()},quitarFoco:function(){this.kText.setFontStyle("normal"),this.kText.setLineHeight(1),this.kText.setText(this.arbol.elemento.texto),this.capa.draw()},setX:function(a){this.group.setX(a)},getX:function(){return this.group.getX()},setY:function(a){this.group.setY(a)},getY:function(){return this.group.getY()},getGroup:function(){return this.group},getWidth:function(){return this.group.getWidth()},getHeight:function(){return this.group.getHeight()},editar:function(){MM.teclado.atajos.activo=!1,this.input=new MM.DOM.create("input",{id:"editNodo",value:this.arbol.elemento.texto,style:"position: absolute; top : "+this.getY()*MM.render.getEscala()+"px; "+"left: "+this.getX()*MM.render.getEscala()+"px; "+"width: "+Math.floor(this.arbol.elemento.texto.length/2+2)+"em; "+"min-width: 50px; "+"border: 3px solid "+this.color+"; "+"border-radius: 5px;"+"background-color: "+this.colorFondo+"; "+"color: "+this.color+"; "+"font-family: "+this.kText.getFontFamily()+"; "+"font-size: "+this.kText.getFontSize()+"pt; "+"white-space: pre-wrap; word-wrap: break-word; overflow:hidden; height:auto;"}),this.input.onblur=MM.Class.bind(MM.render,MM.render.editar),this.escenario.content.appendChild(this.input),this.input.select(),this.input.focus()},cerrarEdicion:function(){this.arbol.elemento.texto=this.input.value,this.group.setWidth(this.kText.getWidth()),this.group.setHeight(this.kText.getHeight()),this.line.setPoints([{x:0,y:this.kText.getHeight()},{x:this.kText.getWidth(),y:this.kText.getHeight()}]),MM.teclado.atajos.activo=!0,this.input.remove(),delete this.input,MM.ponerFoco(this.arbol)},nop:function(){},destroy:function(){this.rect.destroy(),this.kText.destroy(),this.group.destroy(),delete this.kText,delete this.group}}),MM.Globo=MM.NodoSimple.extend({init:function(a,b,c){this._super(a,b,c),this.line.hide(),this.rect.show()},ponerFoco:function(){this.rect.setStroke(this.colorFondo),this.rect.setFill(this.color),this.rect.setShadowColor(this.color),this.kText.setFill(this.colorFondo),this.capa.draw()},quitarFoco:function(){this.rect.setStroke(this.color),this.rect.setFill(this.colorFondo),this.rect.setShadowColor("black"),this.kText.setFill(this.color),this.capa.draw()},editar:function(){this.textarea=new MM.DOM.create("textarea",{id:"editNodo",innerHTML:this.getText(),style:"position: absolute; top : "+(this.getY()-5)*MM.render.getEscala()+"px; "+"left: "+(this.getX()-5)*MM.render.getEscala()+"px; "+"width: "+Math.floor(this.arbol.elemento.texto.length/2+2)+"em; "+"min-width: 50px; "+"height: 2em; "+"border: 3px solid "+this.color+"; "+"border-radius: 5px;"+"background-color: "+this.colorFondo+"; "+"color: "+this.color+"; "+"font-family: "+this.kText.getFontFamily()+"; "+"font-size: "+this.kText.getFontSize()+"pt; "+"white-space: pre-wrap; word-wrap: break-word; overflow:hidden;"}),this.textarea.onblur=MM.Class.bind(MM.render,MM.render.editar),this.escenario.content.appendChild(this.textarea),this.textarea.select(),this.textarea.focus()},cerrarEdicion:function(){this.textarea.onblur=this.nop,MM.undoManager.add(new MM.comandos.Editar(this.arbol.elemento.id,this.arbol.elemento.texto,this.textarea.value)),this.arbol.elemento.texto=this.textarea.value,this.setText(this.textarea.value),this.group.setWidth(this.kText.getWidth()),this.group.setHeight(this.kText.getHeight()),this.rect.setPoints([{x:0,y:0},{x:this.kText.getWidth(),y:0},{x:this.kText.getWidth(),y:this.kText.getHeight()},{x:0,y:this.kText.getHeight()}]),this.textarea.remove(),delete this.textarea,MM.ponerFoco(this.arbol),window.focus()}}),Function.prototype.processable=function(a,b){var c=this;return function(){var d;a&&a.apply(this,arguments);var e=c.apply(this,arguments);return b&&(d=b.apply(this,arguments)),void 0===d?e:d}},"undefined"!=typeof module&&(module.exports=Function.prototype.procesable),MM.Properties={},MM.Properties.add=function(a,b){var c={};for(var d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c},"undefined"!=typeof module){var MM=require("./MindMapJS.js");MM.Class=require("./klass.js")}if(MM.PubSub=MM.Class.extend({eventos:{},idSus:1,init:function(){this.eventos={},this.idSus=1},on:function(a){if(!this.eventos[a])return!1;var b=Array.prototype.slice.call(arguments,1);return this.eventos[a].forEach(function(a){a.funcion.apply(a.contexto,b)}),b=null,!0},suscribir:function(a,b,c){return a&&b?(this.eventos[a]||(this.eventos[a]=[]),c=c||this,this.eventos[a].push({id:this.idSus,contexto:c,funcion:b}),this.idSus++):null},desSuscribir:function(a){for(var b in this.eventos)if(this.eventos[b])for(var c=0,d=this.eventos[b].length;d>c;c++)if(this.eventos[b][c].id===a)return this.eventos[b].splice(c,1),a;return null}}),"undefined"!=typeof module&&(module.exports=MM.PubSub),MM.Render=function(){var a=MM.Class.extend({init:function(a,b,c){this.contenedor=window.document.getElementById(a),this.width=this.contenedor.clientWidth-2,this.height=this.contenedor.clientHeight-2,this.devicePixelRatio=d(),this.Nodo=b||MM.Globo,this.Arista=c||MM.Arista,this.escenario=new Kinetic.Stage({container:a,width:this.width,height:this.height}),this.offset={x:0,y:0},this.capaGrid=new Kinetic.Layer,this.capaNodos=new Kinetic.Layer,this.capaAristas=new Kinetic.Layer,this.escenario.add(this.capaGrid),this.escenario.add(this.capaAristas),this.escenario.add(this.capaNodos)}});a.prototype.aristas=[],a.prototype.suscripciones=[],a.prototype.renderizar=function(){this.capaGrid.removeChildren(),new MM.Grid(this.capaGrid,this.width,this.height),MM.arbol.elemento.reparto={y0:0,y1:this.height};var a=MM.arbol.suscribir("preOrden",MM.Class.bind(this,b)),d=MM.arbol.suscribir("postPreOrden",MM.Class.bind(this,c));MM.arbol.preOrden(),MM.arbol.desSuscribir(a),MM.arbol.desSuscribir(d),this.suscribrirEventos(),MM.root(),this.escenario.draw(),this.renderAristas(),MM.definirAtajos(),a=d=null},a.prototype.suscribrirEventos=function(){this.desuscribrirEventos(),this.suscripciones.push(MM.eventos.suscribir("ponerFoco",e)),this.suscripciones.push(MM.eventos.suscribir("add",this.nuevoNodo,this)),this.suscripciones.push(MM.eventos.suscribir("borrar",this.borrarNodo,this)),this.suscripciones.push(MM.eventos.suscribir("nuevo/pre",function(){MM.arbol.elemento.nodo.destroy()})),this.suscripciones.push(MM.eventos.suscribir("nuevo/post",function(){this.renderizar()},this))},a.prototype.desuscribrirEventos=function(){this.suscripciones.forEach(function(a){MM.eventos.desSuscribir(a)}),this.suscripciones=[]},a.prototype.renderAristas=function(){this.capaAristas&&(this.capaAristas.clear(),this.aristas.forEach(function(a){a.render()}))},a.prototype.nuevoNodo=function(a,b){this.repartoEspacio(a),this.aristas.push(new this.Arista(this.capaAristas,a.elemento,b.elemento,"3")),this.renderAristas(),this.capaNodos.draw(),MM.ponerFoco(b),this.editar()},a.prototype.repartoEspacio=function(a){var b=MM.arbol.profundidad(a.elemento.id),c=a.elemento.reparto;this.posicionarNodo(a,b);var d=c.y0,e=(c.y1-c.y0)/a.hijos.length;e=22>e?22:e,a.hijos.forEach(function(a){a.elemento.reparto={y0:d,y1:d+e},this.posicionarNodo(a,b+1),d+=e},this),b=c=d=e=null},a.prototype.posicionarNodo=function(a,b){var c=a.elemento,d=c.reparto,e=25+150*b,f=d.y0+(d.y1-d.y0)/2-11;null!==c.nodo?(c.nodo.setX(e),c.nodo.setY(f)):c.nodo=new this.Nodo(this,a,{x:e,y:f,text:c.texto}),c=d=e=f=null};var b=function(a){this.repartoEspacio(a)},c=function(a){var b=a.elemento;a.hijos.forEach(function(a){var c=new this.Arista(this.capaAristas,b,a.elemento,"3");this.aristas.push(c),c=null},this),b=null},d=function(){return window.devicePixelRatio?window.devicePixelRatio:1};a.prototype.buscarArista=function(a,b){for(var c=0;c<this.aristas.length;c++)if(a.elemento.id===this.aristas[c].elementoOrigen.id&&b.elemento.id===this.aristas[c].elementoDestino.id)return c;return null},a.prototype.borrarArista=function(a,b){for(var c=0;c<this.aristas.length;c++)if(a.elemento.id===this.aristas[c].elementoOrigen.id&&b.elemento.id===this.aristas[c].elementoDestino.id)return this.aristas.splice(c,1);return null},a.prototype.borrarHijo=function(a,b){for(var c=0;c<a.hijos.length;c++)if(a.hijos[c].elemento.id===b.elemento.id)return a.hijos.splice(c,1);return null},a.prototype.borrarNodo=function(a,b){for(var c=0;c<b.hijos.length;c)this.borrarNodo(b,b.hijos[c]);this.borrarArista(a,b),b.elemento.nodo.destroy(),this.borrarHijo(a,b),this.repartoEspacio(a),this.renderAristas(),this.capaNodos.draw(),c=null},a.prototype.getEscala=function(){var a=MM.render.escenario.getScale();return a.x},a.prototype.setEscala=function(a){MM.render.escenario.setScale({x:a,y:a}),MM.render.capaNodos.draw(),MM.render.renderAristas()},a.prototype.zoomIn=function(){var a=MM.render.getEscala();MM.render.setEscala(a+.05),MM.undoManager.add(new MM.comandos.Zoom(a,a+.05))},a.prototype.zoomOut=function(){var a=MM.render.getEscala();a>=.05&&(MM.render.setEscala(a-.05),MM.undoManager.add(new MM.comandos.Zoom(a,a-.05)))},a.prototype.zoomReset=function(){MM.render.setEscala(1),MM.undoManager.add(new MM.comandos.Zoom(MM.render.getEscala(),1))};var e=function(a,b){f&&MM.render.editar(),null!==a&&null!==a.elemento.nodo&&a.elemento.nodo.quitarFoco(),null!==b&&null!==b.elemento.nodo&&b.elemento.nodo.ponerFoco()},f=!1;return a.prototype.editar=function(){f?(f=!1,MM.foco.elemento.nodo.cerrarEdicion()):(f=!0,MM.foco.elemento.nodo.editar())},a.prototype.modoEdicion=function(){return f},a.prototype.insertarSaltoDeLinea=function(){f&&(MM.foco.elemento.nodo.textarea.value=MM.foco.elemento.nodo.textarea.value+"\n")
},a}(),"undefined"!=typeof module)var MM=require("./MindMapJS.js");if(MM.teclado={},MM.teclado.tecla={f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,shift:16,ctrl:17,alt:18,leftMeta:91,rightMeta:92,scrolllock:145,numlock:144,capslock:20,pageup:33,pagedown:34,left:37,up:38,right:39,down:40,ins:45,home:36,del:46,end:35,backspace:8,tab:9,enter:13,esc:27,escape:27,space:32},MM.teclado.tecla.excepciones={171:"+",187:"+",221:"+",107:"+",173:"-",189:"-",191:"-",109:"-",96:"0"},MM.teclado.keyDown=function(a){if(!MM.teclado.atajos.activo)return!0;var b=a?a:window.event,c=window.Event?b.which:b.keyCode,d=MM.teclado.tecla.nombre(c,b);if(MM.teclado.tecla.esModificador(c))return b=c=d=e=null,!0;var e=MM.teclado.atajos.calcular(d,b);return MM.teclado.atajos.definidos[e]&&(b.preventDefault(),b.stopPropagation()),MM.teclado.atajos.lanzar(e),b=c=d=e=null,!1},MM.teclado.tecla.nombre=function(a){if(this.excepciones[a])return this.excepciones[a];for(var b in this)if(a===this[b])return b;return String.fromCharCode(a)},MM.teclado.tecla.valor=function(a){return this[a]},MM.teclado.tecla.esModificador=function(a){return a===this.ctrl||a===this.alt||a===this.shift||a===this.leftMeta||a===this.rightMeta},MM.teclado.tecla.esControl=function(a){return a===this.ctrl},MM.teclado.tecla.esAlt=function(a){return a===this.alt},MM.teclado.tecla.esShift=function(a){return a===this.shift},MM.teclado.tecla.esMeta=function(a){return a===this.leftMeta||a===this.rightMeta},MM.teclado.atajos={activo:!0,definidos:{},contextos:{},ctrl:!1,shift:!1,alt:!1,window:!1},MM.teclado.atajos.add=function(a,b,c){this.definidos[a]=b,this.contextos[a]=c||this},MM.teclado.atajos.calcular=function(a,b){var c=new RegExp("\\+"+a+"$","i"),d=/ctrl\+/i,e=/alt\+/i,f=/shift\+/i,g=/meta\+/i;for(var h in this.definidos){if(a===h)return h;if(c.test(h)&&(b.ctrlKey?d.test(h):!d.test(h))&&(b.altKey||b.altGraphKey?e.test(h):!e.test(h))&&(b.shiftKey?f.test(h):!f.test(h))&&(b.metaKey?g.test(h):!g.test(h)))return h}return c=d=e=f=g=null,null},MM.teclado.atajos.lanzar=function(a){this.definidos[a]&&this.definidos[a].apply(this.contextos[a],[])},"undefined"!=typeof module&&(module.exports=MM.teclado),window&&window.addEventListener("keydown",MM.teclado.keyDown,!0),"undefined"!=typeof module){var MM=require("./MindMapJS.js");MM.Class=require("./klass.js"),MM.PubSub=require("./pubsub.js")}MM.UndoManager=MM.Class.extend(function(){var a=[],b=10,c=-1,d=new MM.PubSub,e=function(a){b=a||10},f=function(b){g(),a.push(b),c=a.length-1,h(),d.on("add"),d.on("cambio")},g=function(){-1!==c&&c<a.length-1&&(a=a.slice(0,c+1))},h=function(){c===b&&(a.shift(),c--)},i=function(){a[c+1]&&(a[c+1].hacer(),k(),d.on("hacer"),d.on("cambio"))},j=function(){-1!==c&&(a[c].deshacer(),l(),d.on("deshacer"),d.on("cambio"))},k=function(){c<a.length-1&&(c++,d.on("avanzar"),d.on("cambio"))},l=function(){c>=0&&(c--,d.on("retroceder"),d.on("cambio"))},m=function(){return a[c+1]?a[c+1].nombre:null},n=function(){return-1!==c?a[c].nombre:null},o=function(){return a.map(function(a){return a.nombre})};return{init:e,nombres:o,hacerNombre:m,deshacerNombre:n,actual:function(){return c},add:f,hacer:i,deshacer:j,eventos:d}}()),MM.UndoManager.ComandoHacerDeshacer=MM.Class.extend({init:function(a,b,c){this.nombre=a,this.hacerCallBack=b,this.deshacerCallBack=c},hacer:function(){this.hacerCallBack()},deshacer:function(){this.deshacerCallBack()}}),"undefined"!=typeof module&&(module.exports.UndoManager=MM.UndoManager);